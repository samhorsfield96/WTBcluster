# WTBcluster: a snakemake pipeline for clustering loads of proteins

WTBcluster (stands for 'Woooowww That's Big-cluster') calls bacterial proteins using [Prodigal](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-11-119) iteratively clusters proteins using [Linclust](https://www.nature.com/articles/s41467-018-04964-5), part of the [MMseqs2](https://www.nature.com/articles/nbt.3988) suite of tools.

## Dependencies:

* python>=3.9
* pyrodigal
* mmseqs2
* pandas
* biopython
* snakemake
* python-rocksdb
* natsort

## To install:

Install the required packages using [conda](https://conda.io/projects/conda/en/latest/user-guide/install/index.html)/[mamba](https://github.com/mamba-org/mamba):

```
git clone https://github.com/samhorsfield96/WTBcluster.git
cd WTBcluster
mamba env create -f environment.yml
mamba activate WTBcluster
```

## Running iterative or parallel:

WTBcluster has two modes for initial runs: 
- `parallel`: runs mmseqs batches in parallel and merges at the end. This will run more quickly but use more memory.
- `iter`: runs mmeseqs batches iteratively, merging at each step. This will run more slowly but use less memory.

The results will be slightly different depending on which mode is chosen, if `mmseqs2_num_batches` is set to >1, otherwise all sequences are clustered together and there is no difference.

Update `config.yaml` to specify workflow and directory paths.
- `output_dir`: path to output directory. Does not need to exist prior to running.
- `file_list`: path to file containing paths to FASTA files (gzipped or uncompressed), one per line.
- `pyrodigal_num_batches`: number of pyrodigal batches to split the `file_list` into.
- `mmseqs2_num_batches`: number of mmseqs2 batches to split the `file_list` into. This will impact clustering accuracy if >1, but will be more scalable.
- `mmseqs2_min_ID`: minimum identity between two CDS to be clustered.
- `mmseqs2_min_cov`: minimum sequence coverage between two CDS to be clustered.
- `mmseqs2_cov_mode`: method to calculate coverage between two CDS (See [guide](https://mmseqs.com/latest/userguide.pdf))
- `mmseqs2_ID_mode`: method to calculate identity between two CDS (See [guide](https://mmseqs.com/latest/userguide.pdf))
- `mmseqs2_tmp_dir`: temporary directory for MMseqs2 processing.


Run snakemake, replacing `<path/to/snakefile>` with either a path to `Snakefile_iter` or `Snakefile_parallel`.

```
snakemake -s <path/to/Snakefile>  --cores <cores>
```

## Running update:

WTBcluster also enables updating of previous runs with new genomes

The `config_update.yaml` should be updated to specify workflow and directory paths. It has the same arguments as the previous modes, with some additional parameters:
- `prev_run_reps`: path to the final `rep_seq.fasta` file generated by the previous run. Will either be the highest `N` in `mmseqs2_clustering/clustering_N_rep_seq.fasta` for `iter` or the `mmseqs2_clustering_final/final_rep_seq.fasta` for `parallel`.
- `prev_merged_clusters`: path to `merged_clusters` directory.

Run snakemake:

```
snakemake -s <path/to/Snakefile_update> --cores <cores>
```

## Outputs

All workflows output the following directories:
- `pyrodigal_input_batches`: batched fasta files for pyrodigal to run on.
- `pyrodigal_annotations`: batches of coding sequences in `.ffn`, `.faa` and `.gff` format from pyrodigal.
- `pyrodigal_output_batches`: batches of all pyrodigal outputs.
- `mmseqs2_batches`: concatenated batches of amino acid sequences for MMseqs2 clustering.
- `mmseqs2_clustering`: outputs of clustering via MMseqs2. `all_seqs.fasta` are all sequences clustered, `rep_seq.fasta` are representative sequences from clustering, and `cluster.tsv` describes each cluster (first column = representative, second column = sequence).
- `merged_clusters`: merged clusters from multiple MMseqs2 runs. These are intermediate files mainly, however `all_clusters.tsv` provides all merged clusters if MMseqs2 was run iteratively or in parallel. `gene_tokens.db` is a rocksdb database mapping genes to integers for tokenisation.
- `tokenised_genomes`: reformatted genomes, where sequence is replaced by order of clusters of orthologous genes (COGs), represented by an integer per cluster. Strand is identified by either positive or negative numbers, and `_` represents contig breaks.

`parallel` workflow also generates:
- `mmseqs2_clustering_final`: a merging of all MMseqs2 parallel runs, containing `final_all_seqs.fasta`, `final_rep_seq.fasta` and `final_cluster.tsv` (`concatenated_final.fasta` is input file to final MMseqs2 clustering).

`update` does not produce any additional files, however, running it will update `gene_tokens.db` of the previous run in-place. If you wish for this database to be untouched, it is advised to copy this as a backup before running `update`.